import os
import requests
import logging
from ultralytics import YOLO
from PIL import Image
import io

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# ==========================================
# 1. –õ–û–ì–ò–ö–ê YOLO (–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê)
# ==========================================
_model = None

def get_yolo_model():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –º–æ–¥–µ–ª—å –æ–¥–∏–Ω —Ä–∞–∑ –∏ –¥–µ—Ä–∂–∏—Ç –≤ –ø–∞–º—è—Ç–∏"""
    global _model
    if _model:
        return _model
    
    # –õ–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ —Ñ–∞–π–ª–∞ (–∫–∞–∫ –≤ –≤–∞—à–µ–º main.py)
    possible_paths = [
        os.getenv("YOLO_WEIGHTS_PATH"), # –ï—Å–ª–∏ –∑–∞–¥–∞–Ω–æ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
        "best.pt",                      # –í –∫–æ—Ä–Ω–µ
        "cloud_api/best.pt",            # –í –ø–∞–ø–∫–µ –∞–ø–∏
        "models/best.pt",               # –í –ø–∞–ø–∫–µ models
        "/app/best.pt"                  # –ê–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å
    ]
    
    model_path = "yolov8n.pt" # –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
    
    for path in possible_paths:
        if path and os.path.exists(path):
            logger.info(f"üöÄ –ú–æ–¥–µ–ª—å –Ω–∞–π–¥–µ–Ω–∞: {path}")
            model_path = path
            break
    else:
        logger.warning("‚ö†Ô∏è –§–∞–π–ª best.pt –Ω–µ –Ω–∞–π–¥–µ–Ω! –ò—Å–ø–æ–ª—å–∑—É—é —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –º–æ–¥–µ–ª—å.")

    try:
        _model = YOLO(model_path)
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ YOLO: {e}")
        _model = YOLO("yolov8n.pt")
        
    return _model

def analyze_image(image_bytes):
    """–ü—Ä–∏–Ω–∏–º–∞–µ—Ç –±–∞–π—Ç—ã –∫–∞—Ä—Ç–∏–Ω–∫–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–º—è –∫–ª–∞—Å—Å–∞ –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å"""
    try:
        model = get_yolo_model()
        img = Image.open(io.BytesIO(image_bytes)).convert("RGB")
        
        # –ó–∞–ø—É—Å–∫ YOLO
        results = model.predict(source=img, conf=0.25, verbose=False)
        
        if results and results[0].boxes:
            box = results[0].boxes[0]
            cls_id = int(box.cls[0])
            confidence = float(box.conf[0])
            detected_name = model.names[cls_id]
            return detected_name, confidence
            
        return None, 0.0
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ñ–æ—Ç–æ: {e}")
        return "error", 0.0


# ==========================================
# 2. –ë–ê–ó–ê –ó–ù–ê–ù–ò–ô (6 –ü–†–ò–ë–û–†–û–í)
# ==========================================
FAULTS_DB = [
    {"category": "multicooker", "title": "–ú—É–ª—å—Ç–∏–≤–∞—Ä–∫–∞: –û—à–∏–±–∫–∞ E1/E2/E3", "desc": "–ü—Ä–æ–±–ª–µ–º–∞ —Å –¥–∞—Ç—á–∏–∫–∞–º–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã.", "sol": "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞—Ç—á–∏–∫ –Ω–∞ –∫—Ä—ã—à–∫–µ. \n2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —á–∞—à–∞ —Å—É—Ö–∞—è. \n3. –û—Ç–∫–ª—é—á–∏—Ç–µ –æ—Ç —Å–µ—Ç–∏ –Ω–∞ 15 –º–∏–Ω."},
    {"category": "breadmaker", "title": "–•–ª–µ–±–æ–ø–µ—á–∫–∞: –ù–µ –º–µ—Å–∏—Ç —Ç–µ—Å—Ç–æ", "desc": "–î–≤–∏–≥–∞—Ç–µ–ª—å –≥—É–¥–∏—Ç, –ª–æ–ø–∞—Ç–∫–∞ —Å—Ç–æ–∏—Ç.", "sol": "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–º–µ–Ω—å –ø—Ä–∏–≤–æ–¥–∞. \n2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–ø–∞—Ç–∫—É. \n3. –°–º–∞–∂—å—Ç–µ –≤–∞–ª."},
    {"category": "microwave", "title": "–ú–∏–∫—Ä–æ–≤–æ–ª–Ω–æ–≤–∫–∞: –ò—Å–∫—Ä–∏—Ç", "desc": "–¢—Ä–µ—Å–∫ –∏ –≤—Å–ø—ã—à–∫–∏.", "sol": "1. –ó–∞–º–µ–Ω–∏—Ç–µ —Å–ª—é–¥—è–Ω—É—é –ø–ª–∞—Å—Ç–∏–Ω—É. \n2. –£–±–µ—Ä–∏—Ç–µ –º–µ—Ç–∞–ª–ª. \n3. –û—á–∏—Å—Ç–∏—Ç–µ –æ—Ç –∂–∏—Ä–∞."},
    {"category": "smartphone", "title": "–°–º–∞—Ä—Ç—Ñ–æ–Ω: –ë—ã—Å—Ç—Ä–æ —Ä–∞–∑—Ä—è–∂–∞–µ—Ç—Å—è", "desc": "–í—ã–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ 30%.", "sol": "1. –ó–∞–º–µ–Ω–∞ –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä–∞. \n2. –£–¥–∞–ª–∏—Ç–µ –ª–∏—à–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. \n3. –°–±–æ–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞."},
    {"category": "printer", "title": "–ü—Ä–∏–Ω—Ç–µ—Ä: –ñ—É–µ—Ç –±—É–º–∞–≥—É", "desc": "–õ–∏—Å—Ç –∑–∞—Å—Ç—Ä–µ–≤–∞–µ—Ç.", "sol": "1. –ü–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π –ø—Ä–µ–¥–º–µ—Ç –≤ –ª–æ—Ç–∫–µ. \n2. –ü—Ä–æ—Ç—Ä–∏—Ç–µ —Ä–æ–ª–∏–∫–∏ —Å–ø–∏—Ä—Ç–æ–º."},
    {"category": "laptop", "title": "–ù–æ—É—Ç–±—É–∫: –ì—Ä–µ–µ—Ç—Å—è", "desc": "–®—É–º –∏ –≥–æ—Ä—è—á–∏–π –∫–æ—Ä–ø—É—Å.", "sol": "1. –ß–∏—Å—Ç–∫–∞ –æ—Ç –ø—ã–ª–∏. \n2. –ó–∞–º–µ–Ω–∞ —Ç–µ—Ä–º–æ–ø–∞—Å—Ç—ã."}
]


# ==========================================
# 3. –ò–ò –ü–û–ú–û–©–ù–ò–ö (DeepSeek)
# ==========================================
def ask_ai(user_text, device_type="–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ"):
    api_key = os.getenv("DEEPSEEK_API_KEY")
    
    if not api_key:
        return "–û—à–∏–±–∫–∞: –ù–µ –Ω–∞–π–¥–µ–Ω API –∫–ª—é—á DeepSeek."

    system_role = (
    "–¢—ã ‚Äî —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–π —Ç–µ—Ö–Ω–æ–ª–æ–≥-—Ä–æ–±–æ—Ç. "
    "–ü–æ —Ñ–æ—Ç–æ –∏ –æ–ø–∏—Å–∞–Ω–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–ø—Ä–µ–¥–µ–ª—è–µ—à—å –ø–æ–ª–æ–º–∫—É –∏ –≤—ã–¥–∞—ë—à—å —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è —Ä–µ–º–æ–Ω—Ç–∞. "
    "–Ø–∑—ã–∫ ‚Äî –∫–æ—Ä–æ—Ç–∫–∏–π, —Ç–æ—á–Ω—ã–π, –±–µ–∑ –≤–æ–¥—ã.\n"
    "–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:\n"
    "1. –î–∏–∞–≥–Ω–æ–∑ (1 —Å—Ç—Ä–æ–∫–∞).\n"
    "2. –ü—Ä–∏—á–∏–Ω–∞ (1 —Å—Ç—Ä–æ–∫–∞).\n"
    "3. –ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç —Ä–µ–º–æ–Ω—Ç–∞ (–º–∞–∫—Å 5 —à–∞–≥–æ–≤).\n"
    "4. –°–ø–∏—Å–æ–∫ –∑–∞–ø—á–∞—Å—Ç–µ–π/–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é."
    )

    try:
        response = requests.post(
            "https://api.deepseek.com/v1/chat/completions",
            headers={"Authorization": f"Bearer {api_key}"},
            json={
                "model": "deepseek-chat",
                "messages": [
                    {"role": "system", "content": system_role},
                    {"role": "user", "content": user_text}
                ]
            },
            timeout=20
        )
        response.raise_for_status()
        return response.json()['choices'][0]['message']['content']
    except Exception as e:
        logger.error(f"AI Error: {e}")
        return "–ò–ò —Å–µ–π—á–∞—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω."
    