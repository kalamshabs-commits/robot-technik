name: deploy
on:
  push:
    branches: ["main"]
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Build server image
        run: |
          docker build -f robot-tech/cloud_api/Dockerfile.server -t ghcr.io/${{ github.repository_owner }}/robottech-api:latest .
      - name: Login GHCR
        run: echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin
      - name: Push image
        run: docker push ghcr.io/${{ github.repository_owner }}/robottech-api:latest
      - name: Deploy to Cloud Run
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          PROJECT_ID: ${{ secrets.PROJECT_ID }}
        run: |
          echo "$GCP_SA_KEY" > key.json
          gcloud auth activate-service-account --key-file=key.json
          gcloud config set project $PROJECT_ID
          gcloud run deploy robottech-api --image ghcr.io/${{ github.repository_owner }}/robottech-api:latest --region europe-west1 --platform managed --allow-unauthenticated