version: '3.8'
services:
  api:
    build:
      context: .
      dockerfile: robot-tech/cloud_api/Dockerfile.server
    environment:
      - JWT_SECRET=${JWT_SECRET}
      - AES_KEY=${AES_KEY}
    ports:
      - "8000:8000"
  nginx:
    image: nginx:1.25-alpine
    volumes:
      - ./robot-tech/nginx/security.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - api
    ports:
      - "443:443"
    command: /bin/sh -c "apk add --no-cache openssl && mkdir -p /etc/nginx/ssl && openssl req -x509 -nodes -days 365 -subj '/CN=localhost' -newkey rsa:2048 -keyout /etc/nginx/ssl/localhost.key -out /etc/nginx/ssl/localhost.crt && nginx -g 'daemon off;'"